#!/usr/bin/env sh

mainstart=$(date +%s)

export DEBIAN_FRONTEND=noninteractive

echo $PATH > /tmp/temp.path

#sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
#sudo add-apt-repository 'deb [arch=amd64,i386] http://mirrors.accretive-networks.net/mariadb/repo/10.2/ubuntu xenial main'

dd if=/dev/zero of=/var/swap.img bs=1024k count=4000

chown root:root /var/swap.img

chmod 600 /var/swap.img

mkswap /var/swap.img

swapon -s /var/swap.img

curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup \
| sudo bash -s -- --mariadb-server-version=10.2 --skip-maxscale -y | sudo tee -a /tmp/ubuntu-nginx-web-server
sudo apt update

ROOT_SQL_PASS=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1; echo;)

sudo debconf-set-selections <<< 'mariadb-server mysql-server/root_password password $ROOT_SQL_PASS'
sudo debconf-set-selections <<< 'mariadb-server mysql-server/root_password_again password $ROOT_SQL_PASS'

sudo apt-get install -y mariadb-server

cat <<EOF >~/.my.cnf
[client]
user=root
password=$ROOT_SQL_PASS
EOF

cp ~/.my.cnf /etc/mysql/conf.d/my.cnf


sudo bash -c 'echo -e "[user]\n\tGridPane = abc\n\temail = accounts@gridpane.com" > ~/.gitconfig'

wget -qO ee rt.cx/ee && sudo bash ee
ee stack install 
ee stack install --php7 --redis --admin --phpredisadmin 

# Add A Few PPAs To Stay Current

#apt-get install -y --force-yes software-properties-common

#sudo apt-get install -y language-pack-en-base

#export LANG=C.UTF-8

# apt-add-repository ppa:fkrull/deadsnakes-python2.7 -y
#apt-add-repository ppa:nginx/development -y
#apt-add-repository ppa:chris-lea/redis-server -y
#RUN DEBIAN_FRONTEND=noninteractive LC_ALL=en_US.UTF-8  apt-add-repository ppa:ondrej/apache2 -y
#RUN DEBIAN_FRONTEND=noninteractive LC_ALL=en_US.UTF-8 add-apt-repository -y ppa:ondrej/php

# Setup MariaDB Repositories

#sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
#sudo add-apt-repository 'deb [arch=amd64,i386] http://mirrors.accretive-networks.net/mariadb/repo/10.2/ubuntu xenial main'

# Update Package Lists

#apt-get update
# Base Packages

#apt-get install -y --force-yes build-essential curl fail2ban gcc git libmcrypt4 libpcre3-dev \
#make python2.7 python-pip sendmail supervisor ufw unattended-upgrades unzip whois zsh > /tmp/basicsinstall.log

# Install Python Httpie

#pip install httpie

#apt-get install -y --force-yes php7.2-cli php7.2-dev \
#php7.2-pgsql php7.2-sqlite3 php7.2-gd \
#php7.2-curl php7.2-memcached \
#php7.2-imap php7.2-mysql php7.2-mbstring \
#php7.2-xml php7.2-zip php7.2-bcmath php7.2-soap \
#php7.2-intl php7.2-readline > /tmp/phpinstall.log

#sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8

#apt-get update

#DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade

#AUTOGENPASS_ROOT=$(openssl rand -hex 12)

#debconf-set-selections <<< "mariadb-server-10.2 mysql-server/data-dir select ''"
#debconf-set-selections <<< "mariadb-server-10.2 mysql-server/root_password password $AUTOGENPASS_ROOT"
#debconf-set-selections <<< "mariadb-server-10.2 mysql-server/root_password_again password $AUTOGENPASS_ROOT"

# Install MySQL

#apt-get install -y mariadb-server-10.2 > /tmp/mysqlinstall.log

#enc_pass_root=$( echo $AUTOGENPASS_ROOT | openssl enc -a -salt )

# Configure Access Permissions For Root & GridPane Users

#sed -i '/^bind-address/s/bind-address.*=.*/bind-address = */' /etc/mysql/my.cnf
#mysql --user="root" --password="$AUTOGENPASS_ROOT" -e "GRANT ALL ON *.* TO root@'"$serverIP"' IDENTIFIED BY 'QEKcD3uHBb3dxOaTP5J0';"
#mysql --user="root" --password="$AUTOGENPASS_ROOT" -e "GRANT ALL ON *.* TO root@'%' IDENTIFIED BY 'QEKcD3uHBb3dxOaTP5J0';"
#service mysql restart

#mysql --user="root" --password="$AUTOGENPASS_ROOT" -e "CREATE USER 'gridpane'@'"$serverIP"' IDENTIFIED BY 'QEKcD3uHBb3dxOaTP5J0';"
#mysql --user="root" --password="$AUTOGENPASS_ROOT" -e "GRANT ALL ON *.* TO 'gridpane'@'"$serverIP"' IDENTIFIED BY 'QEKcD3uHBb3dxOaTP5J0' WITH GRANT OPTION;"
#mysql --user="root" --password="$AUTOGENPASS_ROOT" -e "GRANT ALL ON *.* TO 'gridpane'@'%' IDENTIFIED BY 'QEKcD3uHBb3dxOaTP5J0' WITH GRANT OPTION;"
#mysql --user="root" --password="$AUTOGENPASS_ROOT" -e "FLUSH PRIVILEGES;"

# Set Character Set

#echo "" >> /etc/mysql/my.cnf
#echo "[mysqld]" >> /etc/mysql/my.cnf
#echo "character-set-server = utf8" >> /etc/mysql/my.cnf

# Create The Initial Database If Specified

#mysql --user="root" --password="$AUTOGENPASS_ROOT" -e "CREATE DATABASE gridpane;"

#apt-get -y install python luarocks

#luarocks install lua-resty-waf

mainend=$(date +%s)
totalruntime=$((mainend-mainstart))

echo "Total Updatesafely™ Proceesing Time: $totalruntime seconds!"

echo "Total Updatesafely™ Proceesing Time: $totalruntime seconds!" > /tmp/resty-build.log
